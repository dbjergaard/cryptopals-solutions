#!/usr/bin/env ruby 
require 'curb'
require 'crypto_tools'
require 'block_crypto'
require 'stream_cipher'
require 'openssl'
require 'servers'

def flip_byte(cipher_block,i,tb,pb)
  bytes=cipher_block.bytes()
  bytes[-i]=(bytes[-i]^tb)^pb
  return bytes.pack("C*")
end
def create_edit_text(input_block,decoded_bytes,pad_byte)
  edited_block=input_block
  1.upto(pad_byte) do |i| 
    edited_block=flip_byte(edited_block,i, decoded_bytes[i-1], pad_byte)
  end
  return edited_block
end
def challenge17
  server = CBCPaddingServer.new
  iv,session_cookie = server.get_session_cookie()
  block_size=16
  blocks=session_cookie.blocks(block_size)
  blocks=[iv]+blocks
  decoded_byte_string=[]
  1.upto(blocks.length-1) do |bi| 
    decoded_bytes=[]
    block=blocks[-bi-1]
    target_block=blocks[-bi]
    1.upto(block_size) do |pad_byte| 
      256.times do |byte| 
        if byte == pad_byte and pad_byte==1
          next
        end
        decoded_bytes[pad_byte-1]=byte
        edited_block=create_edit_text(block,decoded_bytes,pad_byte)
        if server.valid_decrypt(edited_block+target_block,iv)
          break
        end
      end
    end
    decoded_byte_string+=decoded_bytes
  end
  plain_text=decoded_byte_string.pack("C*").reverse.pkcs7strip
  if plain_text.scan(/[^[:print:]]/).length > 1
    raise "Challenge 17 failed!"
  else
    puts "Challenge 17 passed!"
  end
end
def challenge18
  message="Hello Dave, this is a secret"
  cipher_text=StreamCrypto.aes_ctr_encrypt(message,"\0"*8,"YELLOW SUBMARINE")
  clear_text=StreamCrypto.aes_ctr_decrypt(clear_text,"\0"*8,"YELLOW SUBMARINE")
  if clear_text!=message
    raise "Challenge 18 is broken!"
  end
end
def run_challenges
  challenge17
  challenge18
end

run_challenges
